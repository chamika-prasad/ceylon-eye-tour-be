name: Deploy to Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # This fetches all history for proper change detection

    - name: Check for file changes
      id: changes
      run: |
        # Get the previous successful deployment commit
        if [ -f .github/last-deployed-commit ]; then
          LAST_DEPLOYED=$(cat .github/last-deployed-commit)
        else
          # First deployment - compare with initial commit
          LAST_DEPLOYED=$(git rev-list --max-parents=0 HEAD)
        fi
        
        CURRENT_COMMIT=${{ github.sha }}
        
        echo "Last deployed: $LAST_DEPLOYED"
        echo "Current commit: $CURRENT_COMMIT"
        
        # Check for package.json changes
        if git diff --name-only $LAST_DEPLOYED $CURRENT_COMMIT | grep -q "package.json"; then
          echo "package_changed=true" >> $GITHUB_OUTPUT
          echo "package.json changed"
        else
          echo "package_changed=false" >> $GITHUB_OUTPUT
          echo "No changes in package.json"
        fi
        
        # Check for database/setup.js changes
        if git diff --name-only $LAST_DEPLOYED $CURRENT_COMMIT | grep -q "database/setup.js"; then
          echo "db_changed=true" >> $GITHUB_OUTPUT
          echo "database/setup.js changed"
        else
          echo "db_changed=false" >> $GITHUB_OUTPUT
          echo "No changes in database/setup.js"
        fi
        
        # Save current commit for next deployment
        echo $CURRENT_COMMIT > .github/last-deployed-commit

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /root/ceylon-eye-tour-be
          
          echo "Stopping application..."
          pm2 stop 0
          
          echo "Pulling latest code..."
          git pull origin main
          
          # Install dependencies only if package.json changed
          if [ "${{ steps.changes.outputs.package_changed }}" == "true" ]; then
            echo "package.json changed. Installing dependencies..."
            npm install
          else
            echo "No changes in package.json. Skipping npm install."
          fi
          
          # Run database setup only if database/setup.js changed
          if [ "${{ steps.changes.outputs.db_changed }}" == "true" ]; then
            echo "database/setup.js changed. Running database setup..."
            npm run setup-db
            npm run seed-db
          else
            echo "No changes in database/setup.js. Skipping database setup."
          fi
          
          echo "Starting application..."
          pm2 start 0
          pm2 save
          
          echo "Deployment completed successfully!"